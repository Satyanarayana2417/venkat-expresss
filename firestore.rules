rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // HELPER FUNCTIONS
    // ============================================
    
    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Check if user is admin
    function isAdmin() {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Check if user owns the resource
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // ============================================
    // USERS COLLECTION
    // ============================================
    match /users/{userId} {
      // Users can read and write their own profile
      allow read: if isAuthenticated() && (isOwner(userId) || isAdmin());
      allow create: if isAuthenticated() && isOwner(userId);
      allow update: if isAuthenticated() && (isOwner(userId) || isAdmin());
      allow delete: if isAdmin();
    }
    
    // ============================================
    // ORDERS COLLECTION
    // ============================================
    match /orders/{orderId} {
      // Allow users to CREATE their own orders during checkout
      allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid;
      
      // Allow users to READ their own orders OR admins to read all orders
      allow read: if isAuthenticated() && 
                     (resource.data.userId == request.auth.uid || isAdmin());
      
      // Allow users to UPDATE only cancellation fields OR admins to update any field
      allow update: if isAuthenticated() && (
        // Admins can update any field
        isAdmin() ||
        // Users can only update their own orders with restricted fields
        (request.auth.uid == resource.data.userId && 
         request.resource.data.userId == resource.data.userId && // Can't change userId
         onlyUpdatingCancellationFields())
      );
      
      // Allow ADMINS to DELETE orders
      allow delete: if isAdmin();
      
      // Helper function: Check if only cancellation-related fields are being updated
      function onlyUpdatingCancellationFields() {
        let allowedFields = ['status', 'cancellationReason', 'cancellationRequestedAt', 'previousStatus'];
        let updatedKeys = request.resource.data.diff(resource.data).affectedKeys();
        
        // Check that all updated keys are in the allowed list
        // AND the status is being changed to 'cancellation-pending'
        return updatedKeys.hasOnly(allowedFields) &&
               request.resource.data.status == 'cancellation-pending';
      }
    }
    
    // ============================================
    // ADDRESSES COLLECTION
    // ============================================
    match /addresses/{addressId} {
      // Users can read, create, update, and delete their own addresses
      allow read: if isAuthenticated() && 
                     (resource.data.userId == request.auth.uid || isAdmin());
      allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && 
                       (resource.data.userId == request.auth.uid || isAdmin());
      allow delete: if isAuthenticated() && 
                       (resource.data.userId == request.auth.uid || isAdmin());
    }
    
    // ============================================
    // PRODUCTS COLLECTION
    // ============================================
    match /products/{productId} {
      // Anyone can read products
      allow read: if true;
      // Only admins can create, update, or delete products
      allow create, update, delete: if isAdmin();
    }
    
    // ============================================
    // CATEGORIES COLLECTION
    // ============================================
    match /categories/{categoryId} {
      // Anyone can read categories
      allow read: if true;
      // Only admins can create, update, or delete categories
      allow create, update, delete: if isAdmin();
    }
    
    // ============================================
    // SETTINGS COLLECTION (Admin Settings)
    // ============================================
    match /settings/{settingId} {
      // Anyone can read settings (for public display)
      allow read: if true;
      // Only admins can create, update, or delete settings
      allow create, update, delete: if isAdmin();
    }
    
    // ============================================
    // AUDIT LOGS COLLECTION
    // ============================================
    match /auditLogs/{logId} {
      // Only admins can read audit logs
      allow read: if isAdmin();
      // Only system/admins can create logs (no updates or deletes)
      allow create: if isAdmin();
      allow update, delete: if false; // Audit logs are immutable
    }
    
    // ============================================
    // CARTS COLLECTION
    // ============================================
    match /carts/{cartId} {
      // Users can manage their own cart
      allow read: if isAuthenticated() && 
                     (resource.data.userId == request.auth.uid || isAdmin());
      allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && 
                       (resource.data.userId == request.auth.uid || isAdmin());
      allow delete: if isAuthenticated() && 
                       (resource.data.userId == request.auth.uid || isAdmin());
    }
    
    // ============================================
    // REVIEWS COLLECTION
    // ============================================
    match /reviews/{reviewId} {
      // Anyone can read reviews
      allow read: if true;
      // Authenticated users can create reviews
      allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid;
      // Users can update/delete their own reviews, admins can do anything
      allow update, delete: if isAuthenticated() && 
                               (resource.data.userId == request.auth.uid || isAdmin());
    }
    
    // ============================================
    // WISHLIST COLLECTION
    // ============================================
    match /wishlists/{wishlistId} {
      // Users can manage their own wishlist
      allow read: if isAuthenticated() && 
                     (resource.data.userId == request.auth.uid || isAdmin());
      allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && 
                       (resource.data.userId == request.auth.uid || isAdmin());
      allow delete: if isAuthenticated() && 
                       (resource.data.userId == request.auth.uid || isAdmin());
    }
    
    // ============================================
    // NOTIFICATIONS COLLECTION
    // ============================================
    match /notifications/{notificationId} {
      // Users can read their own notifications
      allow read: if isAuthenticated() && 
                     (resource.data.userId == request.auth.uid || isAdmin());
      // Only system/admins can create notifications
      allow create: if isAdmin();
      // Users can update (mark as read) their own notifications
      allow update: if isAuthenticated() && 
                       resource.data.userId == request.auth.uid;
      // Only admins can delete
      allow delete: if isAdmin();
    }
    
    // ============================================
    // ABOUT IMAGES COLLECTION (CMS)
    // ============================================
    match /aboutImages/{imageId} {
      // Anyone can read about images
      allow read: if true;
      // Only admins can create, update, or delete
      allow create, update, delete: if isAdmin();
    }
    
    // ============================================
    // BANNERS COLLECTION
    // ============================================
    match /banners/{bannerId} {
      // Anyone can read banners
      allow read: if true;
      // Only admins can create, update, or delete
      allow create, update, delete: if isAdmin();
    }
    
    // ============================================
    // QUOTES COLLECTION (Admin Feature)
    // ============================================
    match /quotes/{quoteId} {
      // Only admins can read quotes
      allow read: if isAdmin();
      // Anyone can create quote requests
      allow create: if true;
      // Only admins can update or delete
      allow update, delete: if isAdmin();
    }
    
    // ============================================
    // DEFAULT DENY
    // ============================================
    // All other collections are denied by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
